{% extends "::Base.html.twig" %}

{% block body %}
<div class="n10load">
    {#
    <div class="blocgau">
        {{ include("BaseNrohoBundle:Default:menu.html.twig") }}
    </div>
    #}
    <div class="menucompte1">
        <div class="menucompte2">
            <nav class="menuinf1">
                <ul>
                    {% for data in product %}
                    <li>
                        <div class="echangi3">
                            {% if data.gender == 0 %}
                                <img src="{{ asset('bundles/basenroho/img/rose_nroho_covoiturage_algerie.png') }}">
                            {% else %}
                                <img src="{{ asset('bundles/basenroho/img/moustache_nroho_covoiturage_algerie.png') }}">
                            {% endif %}
                        </div>
                        <a href="#" id="{{ data.user_id }}" class="recup_id" onclick="return false;">
                            {{ data.secondename }}
                            {# dump(data) #}
                        </a>
                            {{ data.depot|date('d/m/Y') }}
                    </li>
                    {% endfor %}
                </ul>
            </nav>
        </div>
        <div class="contenu2">
            <h2 id="msgway">
                Messagerie
            </h2>
            <nav class="menuinf2" id="msglist">
                <li>
                    <div class="echangi3">
                        <img src="{{ asset('bundles/basenroho/img/rose_nroho_covoiturage_algerie.png') }}">
                    </div>
                    <div class="echangi3r"> 
                        <a href="#">Karim</a>
                            4 Juin
                    </div>
                    <div class="echangi3r">
                        <p>	
                            30 petites secondes pour vous permettre de prendre une meilleure décision que si vous aviez passé des heures 
                            à chercher sur la toile. 30 secondes pour ranger sur votre écran les informations triées de tous covoitureurs. 
                            Et de tous ceux que vous ne connaissiez pas encore.
                        </p>
                    </div>
                </li>
                <li>
                    <div>
                        <img src="{{ asset('bundles/basenroho/img/rose_nroho_covoiturage_algerie.png') }}">
                    </div>
                    <div> 
                        <a href="#" style="text-align: right;">Karim</a>
                            4 Juin
                    </div>
                    <div>
                        <p>	
                            30 petites secondes pour vous permettre de prendre une meilleure décision que si vous aviez passé des heures 
                            à chercher sur la toile. 30 secondes pour ranger sur votre écran les informations triées de tous covoitureurs. 
                            Et de tous ceux que vous ne connaissiez pas encore.
                        </p>
                    </div>
                </li>
            </nav>
            <form class="contenu4" method="post" action="#" id="msgsub">	
                <div class="detaily">
                    <div class="publiyo">
                        <div class="commesg">
                            <div class="textary">
                                <textarea onFocus="if (this.value=='Votre réponse...') this.value=''" class="textaro" name="message" id="msg" placeholder="Votre réponse..."></textarea>
                            </div>
                            <input class="ccabirati" name="mail" type="text" size="35" value=""/>
                        </div>
                        <div class="publio">
                            <div class="boutina">
                                <input class="publiera" name="valider" type="submit" value="Répondre"/>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% set id = app.user.id %}
{% endblock %}

{% block javascripts %}
<script type="text/javascript" src="{{ asset('bundles/basenroho/js/jquery-1.11.1.min.js') }}"></script>
<script type="text/javascript">
$(document).ready(function(){
    $(".recup_id").on("click", function(){
        var id = this.id;
        var result = "";
        var route1 = "{{ path('nroho_base_message_lecture', { 'id': "111" }) }}";
        var url1 = route1.replace("111", id);
        var idd, ways, url2;
        $.ajax({
            type: "POST",
            url: url1,
            contentType: 'application/json',
            cache: false,
            success: function(json){
                var jsonn = JSON.parse( json );
                //console.log(jsonn);
                if (jsonn !== null){
                    for (var i = 0; i < jsonn.length; i++){
                        if(jsonn[i].user.gender === 1) 
                            url2 = "{{ asset('bundles/basenroho/img/moustache_nroho_covoiturage_algerie.png') }}";
                        else
                            url2 = "{{ asset('bundles/basenroho/img/rose_nroho_covoiturage_algerie.png') }}";
                        result += '\
                            <li>\
                                <div class="echangi3">\
                                    <img src="'+ url2 +'">\
                                </div>\
                                <div class="echangi3r">\
                                    <a href="#">'+ jsonn[i].user.secondename +'</a>\
                                        '+ jsonn[i].depot.substr(0,10) +'\
                                </div>\
                                <div class="echangi3r">\
                                    <p>\
                                        '+ nl2br(jsonn[i].message, true) +'\
                                    </p>\
                                </div>\
                            </li>';
                        ways = jsonn[i].product.depart.substr(5)+' --> '+jsonn[i].product.arrivee.substr(5);
                        if(jsonn[i].user.id === {{ app.user.id }}) idd = jsonn[i].user_dist.id; else idd = jsonn[i].user.id;
                        var product_id = jsonn[i].product.id;
                    }
                    var bouton = '\
                    <div class="detaily">\
                        <div class="publiyo">\
                            <div class="commesg">\
                                <div class="textary">\
                                    <textarea class="textaro" name="message" id="msg" placeholder="Votre réponse..."></textarea>\
                                </div>\
                                <input class="ccabirati" name="mail" type="text" size="35" value=""/>\
                            </div>\
                            <div class="publio">\
                                <div class="boutina">\
                                    <input class="publiera" onclick="return false;" name="valider" type="submit" value="Répondre"/>\
                                </div>\
                            </div>\
                        </div>\
                    </div>';
                    $("#msgway").html(ways);
                    $("#msglist").html(result);
                    $("#msgsub").html(bouton);
                }
                $(".publiera").on("click", function(){
                    var msg  = nl2br($("#msg").val());
                    var route3 = "{{ path('nroho_base_message_submit', { 'id': "111", 'product': "222", 'msg': "333" }) }}";
                    var url3 = route3.replace("111", idd);
                    var url4 = url3.replace("222", product_id);
                    var url5 = url4.replace("333", msg);
                    $.ajax({
                        type: "POST",
                        url: url5,
                        contentType: 'application/json',
                        cache: false,
                        success: function(json){
                            alert(json);
                        }
                    });
                });
            }
        });
    }); 
});

function nl2br(str, is_xhtml) {
  //   example 1: nl2br('Kevin\nvan\nZonneveld');
  //   returns 1: 'Kevin<br />\nvan<br />\nZonneveld'
  //   example 2: nl2br("\nOne\nTwo\n\nThree\n", false);
  //   returns 2: '<br>\nOne<br>\nTwo<br>\n<br>\nThree<br>\n'
  //   example 3: nl2br("\nOne\nTwo\n\nThree\n", true);
  //   returns 3: '<br />\nOne<br />\nTwo<br />\n<br />\nThree<br />\n'

  var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br ' + '/>' : '<br>'; // Adjust comment to avoid issue on phpjs.org display

  return (str + '')
    .replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
}
</script>
{% endblock %}